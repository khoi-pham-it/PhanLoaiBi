<!doctype html>
<html lang="vi">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Phân loại bi màu</title>
  <style>
    body {
      font-family: Inter, system-ui, Segoe UI, Roboto, Arial;
      margin: 0;
      padding: 24px;
      background: linear-gradient(180deg, #071029 0%, #0b1220 100%);
      color: #e6eef8;
      box-sizing: border-box;
    }

    .wrap {
      max-width: 1280px;
      margin: 0 auto;
    }

    header {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      margin-bottom: 16px;
      gap: 10px;
    }

    header h1 {
      justify-self: start;
      font-size: 20px;
      margin: 0;
    }

    header .footer {
      justify-self: center;
    }

    header .timer-container {
      justify-self: end;
    }

    button,
    select {
      background: var(--accent, #7dd3fc);
      border: none;
      padding: 8px 12px;
      border-radius: 10px;
      color: #012a36;
      font-weight: 600;
      cursor: pointer;
    }

    .game {
      background: rgba(255, 255, 255, 0.03);
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(2, 6, 23, 0.6);
      display: flex;
      justify-content: space-around;
      gap: 40px;
    }

    .side-panel {
      flex: 1;
      border: 2px solid #3b82f6;
      border-radius: 12px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.05);
    }

    /* Style cho side panel của người chơi */
    #playerPanel {
      border: 2px solid #6fff00;
      /* Viền màu xanh lá cây */
      background: rgba(111, 255, 0, 0.1);
      /* Nền nhạt với màu xanh lá */
    }

    /* Style cho side panel của AI */
    #aiPanel {
      border: 2px solid #ef4444;
      /* Viền màu đỏ */
      background: rgba(239, 68, 68, 0.1);
      /* Nền nhạt với màu đỏ */
    }

    .footer {
      font-size: 18px;
      text-align: center;
      color: #fcfcfc;
      background: linear-gradient(180deg, #6fff00, #1d4201);
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      margin-top: 20px;
      /* animation: shineFlashfooter 3s ease-in-out infinite; */
    }

    .side-panel h2 {
      text-align: center;
      color: #7dd3fc;
      margin-bottom: 15px;
      font-size: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .board {
      display: flex;
      justify-content: space-around;
      gap: 10px;
      padding: 20px;
      height: 300px;
      align-items: flex-end;
    }

    .bucket {
      width: 100px;
      height: 200px;
      background: linear-gradient(180deg, #2b3b55, #162033);
      border-radius: 8px;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding: 6px;
      position: relative;
      transition: .18s;
      flex-wrap: wrap;
      overflow: auto;
    }

    .bucket span {
      position: absolute;
      top: -20px;
      font-size: 13px;
      color: #94a3b8;
    }

    .bucket .count {
      position: absolute;
      left: 8px;
      bottom: 8px;
      background: rgba(0, 0, 0, 0.25);
      color: #fff;
      font-size: 12px;
      padding: 3px 6px;
      border-radius: 10px;
    }

    .marbles {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 12px;
      min-height: 56px;
    }

    .marble {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: grab;
      display: inline-block;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.45);
      transition: transform .2s;
      user-select: none;
      touch-action: none;
    }

    .marble.red {
      background: #ef4444;
    }

    .marble.yellow {
      background: #facc15;
    }

    .marble.blue {
      background: #3b82f6;
    }

    .marble.dragging {
      opacity: .5;
      transform: scale(1.05);
    }

    .marble.selected {
      outline: 3px solid rgba(125, 211, 252, 0.6);
      transform: scale(1.05);
    }

    .bucket.highlight {
      box-shadow: 0 6px 18px rgba(125, 211, 252, 0.3);
      transform: translateY(-4px);
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .popup {
      background: #1e293b;
      padding: 20px 30px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 8px 30px rgba(0, 0, 0, .6);
    }

    .flying {
      position: fixed;
      z-index: 100;
      pointer-events: none;
      transition: transform .6s ease-in-out, opacity .6s;
    }

    @media (max-width: 1024px) {
      .game {
        flex-direction: column;
        gap: 20px;
      }

      .side-panel {
        width: 100%;
      }
    }

    @media (max-width: 768px) {
      .board {
        height: auto;
        flex-wrap: wrap;
        justify-content: center;
        padding: 10px;
      }

      .bucket {
        width: 80px;
        height: 120px;
      }

      .marble {
        width: 28px;
        height: 28px;
      }
    }

    @media (max-width: 600px) {
      header {
        grid-template-columns: auto;
        grid-template-rows: auto auto auto;
        gap: 5px;
      }

      header h1,
      header .footer,
      header .timer-container {
        justify-self: center;
      }

      .footer {
        font-size: 14px;
        padding: 8px;
      }

      h1 {
        font-size: 18px;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 12px;
      }

      h1 {
        font-size: 16px;
      }

      .bucket {
        width: 60px;
        height: 100px;
      }

      .marble {
        width: 24px;
        height: 24px;
      }

      .footer {
        font-size: 12px;
        text-align: center;
      }
    }

    .bucket[data-color="red"] {
      background: linear-gradient(180deg, #f87171, #991b1b);
      border: 3px solid #ef4444;
    }

    .bucket[data-color="yellow"] {
      background: linear-gradient(180deg, #fde047, #ca8a04);
      border: 3px solid #facc15;
    }

    .bucket[data-color="blue"] {
      background: linear-gradient(180deg, #60a5fa, #1e3a8a);
      border: 3px solid #3b82f6;
    }

    .difficulty-card {
      /* display: flex; */
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      border-radius: 12px;
      width: 280px;
      min-height: 280px;
      text-align: center;
      box-sizing: border-box;
      position: relative;
      gap: 10px;
    }

    .difficulty-card img {
      width: 100px;
      height: 120px;
      /* object-fit: contain; */
      margin-bottom: 10px;
      margin: 0px 0px;
      /* padding-top: 30px; */
    }

    .difficulty-card h3 {
      margin: 0px 0px;
      min-height: 40px;
      /* display: flex; */
      align-items: center;
      justify-content: center;
    }

    .difficulty-card p {
      margin: 0px 0px;
      min-height: 32px;
      /* display: flex; */
      align-items: center;
      justify-content: center;
      width: 100%;
      text-align: center;
      padding: -20px;
    }

    .difficulty-card button {
      margin-top: auto;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 20px;
    }

    .difficulty-card .difficulty-title {
      position: absolute;
      top: 8px;
      left: 8px;
      font-size: 14px;
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 20px;
      color: #fff;
      padding: 10px;
    }

    .difficulty-card.easy .difficulty-title {
      background: #22c55e;
    }

    .difficulty-card.medium .difficulty-title {
      background: #3b82f6;
    }

    .difficulty-card.hard .difficulty-title {
      background: #ef4444;
    }

    .difficulty-card.easy button {
      background: #22c55e;
      width: 200px;
    }

    .difficulty-card.medium button {
      background: #3b82f6;
      width: 200px;
    }

    .difficulty-card.hard button {
      background: #ef4444;
      width: 200px;
    }

    @keyframes floatGlowEasy {

      0%,
      100% {
        text-shadow: none;
        color: #25230a;
      }

      50% {
        transform: scale(1.02);
        text-shadow: 0 0 6px rgba(255, 102, 0, 0.6);
        color: #26bd3a;
      }
    }

    @keyframes floatGlowMedium {

      0%,
      100% {
        text-shadow: none;
        color: #112542;
      }

      50% {
        transform: scale(1.02);
        text-shadow: 0 0 6px rgba(255, 102, 0, 0.6);
        color: #2563eb;
      }
    }

    @keyframes floatGlowHard {

      0%,
      100% {
        transform: translateY(0);
        text-shadow: none;
        color: #3e1818;
      }

      50% {
        transform: scale(1.02);
        text-shadow: 0 0 6px rgba(255, 102, 0, 0.6);
        color: #dc2626;
      }
    }

    @keyframes shineFlashfooter {

      0%,
      100% {
        color: #f4df7a;
        text-shadow: none;
        transform: scale(1);
      }

      50% {
        color: #fff478;
        text-shadow: 0 0 10px rgba(243, 243, 243, 0.8);
        transform: scale(1.001);
      }
    }

    @keyframes shineFlashe {

      0%,
      100% {
        color: #05f932;
        text-shadow: none;
        transform: scale(1);
      }

      50% {
        color: #2c561e;
        text-shadow: 0 0 10px rgba(243, 243, 243, 0.8);
        transform: scale(1.1);
      }
    }

    @keyframes shineFlashm {

      0%,
      100% {
        color: #1f06ff;
        text-shadow: none;
        transform: scale(1);
      }

      50% {
        color: #191a3d;
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        transform: scale(1.1);
      }
    }

    @keyframes shineFlashh {

      0%,
      100% {
        color: #fa4242;
        text-shadow: none;
        transform: scale(1);
      }

      50% {
        color: #52271a;
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        transform: scale(1.1);
      }
    }

    .difficulty-card.easy p {
      animation: floatGlowEasy 3s ease-in-out infinite;
    }

    .difficulty-card.medium p {
      animation: floatGlowMedium 3s ease-in-out infinite;
    }

    .difficulty-card.hard p {
      animation: floatGlowHard 3s ease-in-out infinite;
    }

    .difficulty-card.easy h3 {
      animation: shineFlashe 2s ease-in-out infinite;
    }

    .difficulty-card.medium h3 {
      animation: shineFlashm 2s ease-in-out infinite;
    }

    .difficulty-card.hard h3 {
      animation: shineFlashh 2s ease-in-out infinite;
    }

    .countdown-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
      font-size: 150px;
      color: white;
      font-weight: bold;
    }

    @keyframes countdownAnim {
      0% {
        transform: scale(0.5);
        opacity: 0;
      }

      50% {
        transform: scale(1.2);
        opacity: 1;
      }

      100% {
        transform: scale(1);
        opacity: 0;
      }
    }
  </style>
</head>

<body>
  <div class="modal" id="difficultyModal"
    style="position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(87, 81, 81, 0.6); z-index:999;">
    <div class="modal-content" style="background:#fff;border-radius:15px;padding:15px 30px;max-width:900px;">
      <h2 style="color: red;"> Chọn bạn 'AI' để thi đấu</h2>
      <div style="display:flex; gap:2px; justify-content:center; flex-wrap:wrap;">
        <div class="difficulty-card easy"
          style="border:3px solid green; padding:15px; border-radius:12px; width:280px; text-align:center;">
          <span class="difficulty-title">DỄ</span>
          <img src="https://thumb.ac-illust.com/ec/ec7de22b20b117c9902b8aade7b999f9_t.jpeg" alt="Dễ"
            style="width:200px;height:200px;">
          <div>
            <h3 style="color:green;">AI HỌC SINH</h3>
            <p>Đã được huấn luyện trong 1 ngày</p>
          </div>
          <button onclick="selectDifficulty('easy')">Chọn</button>
        </div>
        <div class="difficulty-card medium"
          style="border:3px solid blue; padding:15px; border-radius:12px; width:280px; text-align:center;">
          <span class="difficulty-title">TRUNG BÌNH</span>
          <img src="https://thumb.ac-illust.com/0d/0dfdaa95ec8165782835268165b07539_t.jpeg" alt="Trung Bình"
            style="width:200px;height:200px;">
          <div>
            <h3 style="color:blue;">AI ĐẠI HỌC</h3>
            <p>Đã được huấn luyện trong 1 tuần</p>
          </div>
          <button onclick="selectDifficulty('medium')">Chọn</button>
        </div>
        <div class="difficulty-card hard"
          style="border:3px solid red; padding:15px; border-radius:12px; width:280px; text-align:center;">
          <span class="difficulty-title">KHÓ</span>
          <img src="https://i.pinimg.com/564x/0a/d0/c2/0ad0c2dcf22c5257a8bd6385c37aa100.jpg" alt="Khó"
            style="width:200px;height:200px;">
          <div>
            <h3 style="color:red;">AI LÃO LÀNG</h3>
            <p>Đã được huấn luyện trong 1 tháng</p>
          </div>
          <button onclick="selectDifficulty('hard')">Chọn</button>
        </div>
      </div>
    </div>
  </div>
  <div class="wrap">
    <header>
      <h1>Phân loại bi màu</h1>
      <div class="footer">Kéo thả bi màu vào đúng lọ có cùng màu sắc.</div>
      <div class="timer-container">
        <span class="timer">⏱ <span id="timeLeft">30</span>s</span>
      </div>
    </header>
    <section class="game">
      <div class="side-panel" id="playerPanel">
        <div>
          <h2 style="color: #6fff00;">NGƯỜI CHƠI <img
              src="https://i.pinimg.com/736x/8e/d7/60/8ed76088e09e5c6a553f0cc97f076119.jpg" alt="Người chơi"
              style="width:70px; height:70px; border-radius:50%;"></h2>
        </div>
        <div class="board" id="boardHuman">
          <div class="bucket" data-color="red"><span>Đỏ</span>
            <div class="count">0</div>
          </div>
          <div class="bucket" data-color="yellow"><span>Vàng</span>
            <div class="count">0</div>
          </div>
          <div class="bucket" data-color="blue"><span>Xanh</span>
            <div class="count">0</div>
          </div>
        </div>
        <div class="marbles" id="humanMarbles" aria-live="polite"></div>
        <div class="info">Điểm: <span id="scoreHuman">0</span> | <span id="statusHuman">...</span></div>
      </div>
      <div class="side-panel" id="aiPanel">
        <div>
          <h2>AI</h2>
        </div>
        <div class="board" id="boardAI">
          <div class="bucket" data-color="red"><span>Đỏ</span>
            <div class="count">0</div>
          </div>
          <div class="bucket" data-color="yellow"><span>Vàng</span>
            <div class="count">0</div>
          </div>
          <div class="bucket" data-color="blue"><span>Xanh</span>
            <div class="count">0</div>
          </div>
        </div>
        <div class="marbles" id="aiMarbles"></div>
        <div class="info">Điểm: <span id="scoreAI">0</span> | <span id="statusAI">...</span></div>
      </div>
    </section>

  </div>
  <div class="overlay" id="overlay">
    <div class="popup">
      <h2>Kết quả</h2>
      <p id="resultText"></p>
      <button id="btnRestart">Chơi lại</button>
    </div>
  </div>
  <div id="countdown" class="countdown-overlay">
    <span id="countdown-number"></span>
  </div>
  <audio id="soundCorrect" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
  <audio id="soundWrong" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>
  <script>
    let lastTouchTime = 0;
    let aiStarted = false;
    let currentMarble = null;
    let touchTimeout = null;
    let touchStartX = 0;
    let touchStartY = 0;
    let timerStarted = false; // Biến để kiểm tra xem bộ đếm thời gian đã bắt đầu chưa
    let gameStartTime = null; // Thời gian bắt đầu game
    let aiFinishTime = null; // Thời gian AI hoàn thành
    let aiName = '';
    let aiImg = '';
    let aiColor = '';
    let currentDifficulty = 'medium';
    const humanMarblesContainer = document.getElementById('humanMarbles');
    humanMarblesContainer.addEventListener('touchstart', e => {
      e.preventDefault();
      if (!gameActive) return;
      const target = e.target.closest('.marble');
      if (!target || target.parentElement.id !== 'humanMarbles') return;
      document.querySelectorAll('.marble.selected').forEach(m => m.classList.remove('selected'));
      target.classList.add('selected', 'dragging');
      currentMarble = target;
      statusHuman.textContent = `Chọn bi ${target.dataset.color}. Kéo hoặc chạm vào lọ để thả.`;
      lastTouchTime = Date.now();
      const rect = target.getBoundingClientRect();
      touchStartX = e.touches[0].clientX - rect.left;
      touchStartY = e.touches[0].clientY - rect.top;
      target.style.position = 'fixed';
      target.style.zIndex = '1000';
      target.style.left = `${rect.left}px`;
      target.style.top = `${rect.top}px`;
      target.style.transform = 'translate(0px, 0px)';
    }, { passive: false });
    document.addEventListener('touchmove', e => {
      if (!gameActive || !currentMarble) return;
      e.preventDefault();
      const touch = e.touches[0];
      const dx = touch.clientX - touchStartX - currentMarble.getBoundingClientRect().left + (currentMarble.offsetWidth / 2);
      const dy = touch.clientY - touchStartY - currentMarble.getBoundingClientRect().top + (currentMarble.offsetHeight / 2);
      currentMarble.style.transform = `translate(${dx}px, ${dy}px)`;
    }, { passive: false });
    document.addEventListener('touchend', e => {
      if (!gameActive || !currentMarble) return;
      e.preventDefault();
      const touch = e.changedTouches[0];
      const targetElement = document.elementFromPoint(touch.clientX, touch.clientY);
      const bucket = targetElement ? targetElement.closest('#boardHuman .bucket') : null;
      if (!bucket) {
        currentMarble.style.position = 'static';
        currentMarble.style.transform = '';
        currentMarble.style.zIndex = '';
        currentMarble.classList.remove('dragging', 'selected');
        currentMarble = null;
        return;
      }
      handleDrop(bucket, currentMarble);
      currentMarble.style.position = 'static';
      currentMarble.style.transform = '';
      currentMarble.style.zIndex = '';
      currentMarble.classList.remove('dragging', 'selected');
      currentMarble = null;
    }, { passive: false });
    const colors = ['red', 'yellow', 'blue'];
    const humanMarbles = document.getElementById('humanMarbles');
    const aiMarbles = document.getElementById('aiMarbles');
    const scoreHumanEl = document.getElementById('scoreHuman');
    const scoreAIEl = document.getElementById('scoreAI');
    const statusHuman = document.getElementById('statusHuman');
    const statusAI = document.getElementById('statusAI');
    const timeLeftEl = document.getElementById('timeLeft');
    const overlay = document.getElementById('overlay');
    const resultText = document.getElementById('resultText');
    const btnRestart = document.getElementById('btnRestart');
    const soundCorrect = document.getElementById('soundCorrect');
    const soundWrong = document.getElementById('soundWrong');
    let MARBLES_TOTAL = 6;
    let AI_SPEED = 700;
    let TIME_LIMIT = 30;
    let scoreHuman = 0, scoreAI = 0;
    let gameActive = false;
    let mainTimer = null, aiTimer = null;
    let remainingTime = TIME_LIMIT;
    function uid() { return 'm' + Date.now().toString(36) + Math.random().toString(36).slice(2, 8); }
    function updateBucketCounts(boardId) {
      const buckets = document.querySelectorAll(`#${boardId} .bucket`);
      buckets.forEach(b => {
        const countEl = b.querySelector('.count');
        const color = b.dataset.color;
        const cnt = b.querySelectorAll(`.marble.${color}`).length;
        countEl.textContent = cnt;
      });
    }
    function clearBuckets(boardId) {
      document.querySelectorAll(`#${boardId} .bucket`).forEach(b => {
        b.querySelectorAll('.marble').forEach(m => m.remove());
        const countEl = b.querySelector('.count');
        if (countEl) countEl.textContent = 0;
      });
    }
    function createMarble(container, color = null) {
      const c = color || colors[Math.floor(Math.random() * colors.length)];
      const m = document.createElement('div');
      m.className = 'marble ' + c;
      const id = uid();
      m.dataset.color = c;
      m.dataset.id = id;
      m.setAttribute('role', 'button');
      m.setAttribute('aria-label', `Bi ${c}`);
      if (container === humanMarbles) {
        m.draggable = true;
        m.addEventListener('dragstart', e => {
          if (!gameActive) { e.preventDefault(); return; }
          e.dataTransfer.setData('text/plain', id);
          e.dataTransfer.setData('color', c);
          m.classList.add('dragging');
        });
        m.addEventListener('dragend', () => {
          m.classList.remove('dragging');
          m.style.position = 'static';
        });
      } else {
        m.draggable = false;
      }
      container.appendChild(m);
      return m;
    }
    function animateFly(m, target) {
      try {
        const rect = m.getBoundingClientRect();
        const clone = m.cloneNode(true);
        clone.classList.add('flying');
        document.body.appendChild(clone);
        clone.style.left = rect.left + 'px';
        clone.style.top = rect.top + 'px';
        clone.style.width = rect.width + 'px';
        clone.style.height = rect.height + 'px';
        clone.style.transformOrigin = 'center';
        requestAnimationFrame(() => {
          const t = target.getBoundingClientRect();
          const dx = t.left + t.width / 2 - rect.left;
          const dy = t.top + t.height / 2 - rect.top;
          clone.style.transform = `translate(${dx}px, ${dy}px) scale(0.35)`;
          clone.style.opacity = '0';
        });
        setTimeout(() => clone.remove(), 600);
      } catch (e) { /* ignore animation errors */ }
    }
    function handleDrop(bucket, el) {
      const expected = bucket.dataset.color;
      animateFly(el, bucket);
      // Bắt đầu bộ đếm thời gian khi người chơi thả viên bi đầu tiên
      if (!timerStarted) {
        timerStarted = true;
        gameStartTime = Date.now(); // Ghi lại thời gian bắt đầu
        startTimer(TIME_LIMIT);
      }
      setTimeout(() => {
        if (expected === el.dataset.color) {
          bucket.appendChild(el);
          el.style.position = 'static';
          el.style.transform = 'scale(0.7)';
          el.style.margin = '2px';
          scoreHuman++;
          scoreHumanEl.textContent = scoreHuman;
          statusHuman.textContent = '✅ Đúng!';
          soundCorrect && soundCorrect.play().catch(() => { });
          updateBucketCounts('boardHuman');
          if (scoreHuman >= MARBLES_TOTAL) endGameEarly('player');
        } else {
          statusHuman.textContent = '❌ Sai!';
          soundWrong && soundWrong.play().catch(() => { });
          humanMarbles.appendChild(el);
          updateBucketCounts('boardHuman');
        }
        el.classList.remove('selected');
        if (!aiStarted) {
          aiStarted = true;
          runAI();
        }
      }, 220);
    }
    function setupDropHandlers() {
      document.querySelectorAll('#boardHuman .bucket').forEach((bucket, i) => {
        const newBucket = bucket.cloneNode(true);
        bucket.parentNode.replaceChild(newBucket, bucket);
      });
      document.querySelectorAll('#boardHuman .bucket').forEach(bucket => {
        bucket.addEventListener('dragover', e => {
          if (gameActive) {
            e.preventDefault();
            bucket.classList.add('highlight');
          }
        });
        bucket.addEventListener('dragleave', () => bucket.classList.remove('highlight'));
        bucket.addEventListener('drop', e => {
          if (!gameActive) return;
          e.preventDefault();
          bucket.classList.remove('highlight');
          let id = e.dataTransfer.getData('text/plain');
          let el = document.querySelector(`.marble[data-id="${id}"]`) || document.querySelector('.marble.selected');
          if (!el) return;
          handleDrop(bucket, el);
        });
      });
    }
    function runAI() {
      clearBuckets('boardAI');
      const marbles = [...aiMarbles.querySelectorAll('.marble')];
      scoreAI = 0;
      scoreAIEl.textContent = scoreAI;
      let idx = 0;
      statusAI.textContent = 'AI đang phân loại...';
      if (aiTimer) {
        clearInterval(aiTimer);
        aiTimer = null;
      }
      aiTimer = setInterval(() => {
        if (!gameActive || idx >= marbles.length) {
          if (idx >= marbles.length && !aiFinishTime) {
            aiFinishTime = Date.now(); // Ghi lại thời gian AI hoàn thành
            statusAI.textContent = 'AI xong';
          }
          clearInterval(aiTimer);
          aiTimer = null;
          return;
        }
        const m = marbles[idx++];
        const c = m.dataset.color;
        const bucket = document.querySelector(`#boardAI .bucket[data-color="${c}"]`);
        if (bucket) {
          animateFly(m, bucket);
          setTimeout(() => {
            bucket.appendChild(m);
            m.style.position = 'static';
            m.style.transform = 'scale(0.7)';
            m.style.margin = '2px';
            scoreAI++;
            scoreAIEl.textContent = scoreAI;
            updateBucketCounts('boardAI');
          }, 260);
        } else {
          scoreAI++;
          scoreAIEl.textContent = scoreAI;
        }
      }, AI_SPEED);
    }
    function startTimer(t = 30) {
      remainingTime = t;
      timeLeftEl.textContent = remainingTime;
      if (mainTimer) clearInterval(mainTimer);
      mainTimer = setInterval(() => {
        remainingTime--;
        timeLeftEl.textContent = remainingTime;
        if (remainingTime <= 0) {
          clearInterval(mainTimer);
          mainTimer = null;
          if (aiTimer) {
            clearInterval(aiTimer);
            aiTimer = null;
          }
          gameActive = false;
          statusHuman.textContent = '⏹ Hết giờ!';
          statusAI.textContent = '⏹ Hết giờ!';
          showResult();
        }
      }, 1000);
    }
    function endGameEarly(winner) {
      if (mainTimer) {
        clearInterval(mainTimer);
        mainTimer = null;
      }
      if (winner === 'player') {
        statusHuman.textContent = '🎉 Hoàn thành!';
        gameActive = false;
        showResult();
      }
      // Không dừng game khi AI hoàn thành, để người chơi tiếp tục
    }
    function showResult() {
      overlay.style.display = 'flex';
      const playerFinishTime = gameActive ? (Date.now() - gameStartTime) : (TIME_LIMIT * 1000 - remainingTime * 1000); // Thời gian người chơi hoàn thành
      const aiTime = aiFinishTime ? (aiFinishTime - gameStartTime) : Infinity; // Nếu AI chưa hoàn thành, thời gian là Infinity
      let msg = `Bạn: ${Math.floor(playerFinishTime / 1000)} giây | AI: ${aiFinishTime ? Math.floor(aiTime / 1000) + ' giây' : 'Chưa hoàn thành'}<br/>`;
      if (scoreHuman >= MARBLES_TOTAL && (!aiFinishTime || playerFinishTime < aiTime)) msg += "🎉 Bạn thắng!";
      else if (aiFinishTime && aiTime < playerFinishTime) msg += "🤖 AI thắng!";
      else if (playerFinishTime >= TIME_LIMIT * 1000 && !aiFinishTime) msg += "⚖️ Hòa!";
      else if (!aiFinishTime) msg += "🎉 Bạn thắng! (AI chưa hoàn thành)";
      else msg += "⚖️ Hòa!";
      resultText.innerHTML = msg;
    }
    function restart() {
      overlay.style.display = 'none';
      if (mainTimer) {
        clearInterval(mainTimer);
        mainTimer = null;
      }
      if (aiTimer) {
        clearInterval(aiTimer);
        aiTimer = null;
      }
      timerStarted = false; // Reset trạng thái bộ đếm thời gian
      gameStartTime = null; // Reset thời gian bắt đầu
      aiFinishTime = null; // Reset thời gian AI hoàn thành
      document.getElementById("difficultyModal").style.display = "flex";
    }
    btnRestart.addEventListener('click', restart);
    function startCountdown() {
      const countdownEl = document.getElementById('countdown');
      const numberEl = document.getElementById('countdown-number');
      countdownEl.style.display = 'flex';
      let count = 3;
      numberEl.textContent = count;
      const interval = setInterval(() => {
        count--;
        if (count > 0) {
          numberEl.style.animation = 'none';
          numberEl.offsetHeight; // Trigger reflow
          numberEl.style.animation = 'countdownAnim 1s ease-in-out';
          numberEl.textContent = count;
        } else if (count === 0) {
          numberEl.style.animation = 'none';
          numberEl.offsetHeight; // Trigger reflow
          numberEl.style.animation = 'countdownAnim 1s ease-in-out';
          numberEl.textContent = 'Bắt Đầu';
          setTimeout(() => {
            clearInterval(interval);
            countdownEl.style.display = 'none';
            startGame();
          }, 1000);
        }
      }, 1000);
    }
    function startGame() {
      aiStarted = false;
      timerStarted = false; // Reset trạng thái bộ đếm thời gian
      statusAI.textContent = "🤖 Đang chờ bạn...";
      if (gameActive) return;
      const diff = currentDifficulty;
      if (diff === 'easy') {
        MARBLES_TOTAL = 5;
        AI_SPEED = 1200;
        TIME_LIMIT = 30;
      } else if (diff === 'medium') {
        MARBLES_TOTAL = 6;
        AI_SPEED = 700;
        TIME_LIMIT = 30;
      } else {
        MARBLES_TOTAL = 7;
        AI_SPEED = 600;
        TIME_LIMIT = 30;
      }
      // Cập nhật tiêu đề AI với tên, ảnh và màu
      const aiHeader = document.querySelector('#aiPanel h2');
      aiHeader.innerHTML = `AI ${aiName} <img src="${aiImg}" alt="${aiName}" style="width:70px; height:70px; border-radius:50%;">`;
      aiHeader.style.color = aiColor;
      scoreHuman = 0;
      scoreAI = 0;
      scoreHumanEl.textContent = '0';
      scoreAIEl.textContent = '0';
      statusHuman.textContent = 'Bắt đầu';
      statusAI.textContent = 'Chuẩn bị';
      humanMarbles.innerHTML = '';
      aiMarbles.innerHTML = '';
      clearBuckets('boardHuman');
      clearBuckets('boardAI');
      gameActive = true;
      const gameColors = [];
      for (let i = 0; i < MARBLES_TOTAL; i++) {
        gameColors.push(colors[Math.floor(Math.random() * colors.length)]);
      }
      for (let i = 0; i < MARBLES_TOTAL; i++) {
        createMarble(humanMarbles, gameColors[i]);
        createMarble(aiMarbles, gameColors[i]);
      }
      updateBucketCounts('boardHuman');
      updateBucketCounts('boardAI');
      setupDropHandlers();
      timeLeftEl.textContent = TIME_LIMIT; // Hiển thị thời gian ban đầu nhưng chưa bắt đầu đếm ngược
    }
    function selectDifficulty(level) {
      currentDifficulty = level;
      if (level === "easy") {
        aiName = 'HỌC SINH';
        aiImg = 'https://thumb.ac-illust.com/ec/ec7de22b20b117c9902b8aade7b999f9_t.jpeg';
        aiColor = 'green';
      } else if (level === "medium") {
        aiName = 'ĐẠI HỌC';
        aiImg = 'https://thumb.ac-illust.com/0d/0dfdaa95ec8165782835268165b07539_t.jpeg';
        aiColor = 'blue';
      } else {
        aiName = 'LÃO LÀNG';
        aiImg = 'https://i.pinimg.com/564x/0a/d0/c2/0ad0c2dcf22c5257a8bd6385c37aa100.jpg';
        aiColor = 'red';
      }
      document.getElementById("difficultyModal").style.display = "none";
      startCountdown();
    }
    (function initPreview() {
      humanMarbles.innerHTML = '';
      aiMarbles.innerHTML = '';
      const previewColors = [];
      for (let i = 0; i < 4; i++) {
        previewColors.push(colors[Math.floor(Math.random() * colors.length)]);
      }
      for (let i = 0; i < 4; i++) {
        createMarble(humanMarbles, previewColors[i]);
        createMarble(aiMarbles, previewColors[i]);
      }
      updateBucketCounts('boardHuman');
      updateBucketCounts('boardAI');
      setupDropHandlers();
      // Set default AI header for preview
      const aiHeader = document.querySelector('#aiPanel h2');
      aiHeader.innerHTML = `AI ĐẠI HỌC <img src="https://thumb.ac-illust.com/0d/0dfdaa95ec8165782835268165b07539_t.jpeg" alt="ĐẠI HỌC" style="width:70px; height:70px; border-radius:50%;">`;
      aiHeader.style.color = 'blue';
    })();
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.marble.selected').forEach(x => x.classList.remove('selected'));
        if (currentMarble) {
          currentMarble.style.position = 'static';
          currentMarble.style.transform = '';
          currentMarble.classList.remove('dragging');
          currentMarble = null;
        }
      }
    });
    overlay.addEventListener('click', e => {
      if (e.target === overlay) { /* do nothing */ }
    });
  </script>
</body>

</html>