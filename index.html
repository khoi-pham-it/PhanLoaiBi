<!doctype html>
<html lang="vi">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ph√¢n lo·∫°i bi m√†u ‚Äî Ng∆∞·ªùi ch∆°i vs AI</title>
  <style>
    /* --- (style gi·ªØ nguy√™n nh∆∞ c≈©, ƒë√£ r√∫t g·ªçn cho ng·∫Øn) --- */
    body {
      font-family: Inter, system-ui, Segoe UI, Roboto, Arial;
      margin: 0;
      padding: 24px;
      background: linear-gradient(180deg, #071029 0%, #0b1220 100%);
      color: #e6eef8;
      box-sizing: border-box;
    }

    .wrap {
      max-width: 1280px;
      margin: 0 auto;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      gap: 10px;
      flex-wrap: wrap;
    }

    h1 {
      font-size: 20px;
      margin: 0;
    }

    button,
    select {
      background: var(--accent, #7dd3fc);
      border: none;
      padding: 8px 12px;
      border-radius: 10px;
      color: #012a36;
      font-weight: 600;
      cursor: pointer;
    }

    .game {
      background: rgba(255, 255, 255, 0.03);
      padding: 18px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(2, 6, 23, 0.6);
    }

    .boardWrap {
      display: flex;
      gap: 28px;
      justify-content: space-between;
    }

    .side {
      flex: 1;
    }

    .board {
      display: flex;
      justify-content: space-around;
      gap: 10px;
      padding: 20px;
      height: 300px;
      align-items: flex-end;
    }

    .bucket {
      width: 100px;
      height: 200px;
      background: linear-gradient(180deg, #2b3b55, #162033);
      border-radius: 8px;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding: 6px;
      position: relative;
      transition: .18s;
      flex-wrap: wrap;
      overflow: auto;
    }

    .bucket span {
      position: absolute;
      top: -20px;
      font-size: 13px;
      color: #94a3b8;
    }

    .bucket .count {
      position: absolute;
      left: 8px;
      bottom: 8px;
      background: rgba(0, 0, 0, 0.25);
      color: #fff;
      font-size: 12px;
      padding: 3px 6px;
      border-radius: 10px;
    }

    .marbles {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 12px;
      min-height: 56px;
    }

    .marble {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: grab;
      display: inline-block;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.45);
      transition: transform .2s;
      user-select: none;
      touch-action: none;
      /* Th√™m ƒë·ªÉ h·ªó tr·ª£ t·ªët h∆°n tr√™n iOS/Safari */
    }

    .marble.red {
      background: #ef4444;
    }

    .marble.yellow {
      background: #facc15;
    }

    .marble.blue {
      background: #3b82f6;
    }

    .marble.dragging {
      opacity: .5;
      transform: scale(1.05);
    }

    .marble.selected {
      outline: 3px solid rgba(125, 211, 252, 0.6);
      transform: scale(1.05);
    }

    .bucket.highlight {
      box-shadow: 0 6px 18px rgba(125, 211, 252, 0.3);
      transform: translateY(-4px);
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .popup {
      background: #1e293b;
      padding: 20px 30px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 8px 30px rgba(0, 0, 0, .6);
    }

    .flying {
      position: fixed;
      z-index: 100;
      pointer-events: none;
      transition: transform .6s ease-in-out, opacity .6s;
    }

    @media (max-width:768px) {
      .board {
        height: 200px;
      }

      .bucket {
        width: 70px;
        height: 140px;
      }

      .marble {
        width: 28px;
        height: 28px;
      }
    }

    /* Th√™m m√†u n·ªÅn cho t·ª´ng lo·∫°i l·ªç */
    .bucket[data-color="red"] {
      background: linear-gradient(180deg, #f87171, #991b1b);
      /* ƒë·ªè nh·∫°t -> ƒë·ªè ƒë·∫≠m */
    }

    .bucket[data-color="yellow"] {
      background: linear-gradient(180deg, #fde047, #ca8a04);
      /* v√†ng nh·∫°t -> v√†ng ƒë·∫≠m */
    }

    .bucket[data-color="blue"] {
      background: linear-gradient(180deg, #60a5fa, #1e3a8a);
      /* xanh nh·∫°t -> xanh ƒë·∫≠m */
    }

    .bucket[data-color="red"] {
      border: 3px solid #ef4444;
    }

    .bucket[data-color="yellow"] {
      border: 3px solid #facc15;
    }

    .bucket[data-color="blue"] {
      border: 3px solid #3b82f6;
    }

    /* ====== Responsive ====== */
    @media (max-width: 1024px) {
      .boardWrap {
        flex-direction: column;
        gap: 20px;
      }

      .side {
        width: 100%;
      }
    }

    @media (max-width: 768px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .board {
        height: auto;
        flex-wrap: wrap;
        justify-content: center;
        padding: 10px;
      }

      .bucket {
        width: 80px;
        height: 120px;
      }

      .marble {
        width: 28px;
        height: 28px;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 12px;
      }

      h1 {
        font-size: 16px;
      }

      .bucket {
        width: 60px;
        height: 100px;
      }

      .marble {
        width: 24px;
        height: 24px;
      }

      .footer {
        font-size: 12px;
        text-align: center;
      }
    }

    .difficulty-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      /* tr·∫£i ƒë·ªÅu tr√™n chi·ªÅu cao */
      padding: 16px;
      border-radius: 12px;
      width: 200px;
      min-height: 300px;
      /* ƒë·∫£m b·∫£o c√πng chi·ªÅu cao */
      text-align: center;
      box-sizing: border-box;
    }

    .difficulty-card img {
      width: 100px;
      height: 100px;
      object-fit: contain;
      margin-bottom: 10px;
    }

    .difficulty-card h3 {
      margin: 8px 0;
      min-height: 40px;
      /* gi·ªØ ƒë·ªÅu chi·ªÅu cao cho ti√™u ƒë·ªÅ */
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .difficulty-card p {
      margin: 8px 0;
      min-height: 32px;
      /* gi·ªØ ch·ªó cho d√≤ng "ƒê√£ ƒë∆∞·ª£c hu·∫•n luy·ªán..." */
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .difficulty-card button {
      margin-top: auto;
      /* ƒë·∫©y n√∫t xu·ªëng cu·ªëi card */
    }

    /* Hi·ªáu ·ª©ng chung cho ph·∫ßn "ƒê√£ ƒë∆∞·ª£c hu·∫•n luy·ªán trong" */
    @keyframes floatGlow {

      0%,
      100% {
        transform: translateY(0);
        color: #ef4444;
        /* ƒë·ªè */
      }

      50% {
        transform: translateY(-6px);
        color: #facc15;
        /* v√†ng */
      }
    }

    /* Nh·ªãp ri√™ng cho t·ª´ng lo·∫°i */
    .difficulty-card.easy p {
      animation: floatGlow 1.5s ease-in-out infinite;
      /* nhanh */
    }

    .difficulty-card.medium p {
      animation: floatGlow 2.2s ease-in-out infinite;
      /* v·ª´a */
    }

    .difficulty-card.hard p {
      animation: floatGlow 3s ease-in-out infinite;
      /* ch·∫≠m */
    }
  </style>
</head>

<body>
  <!-- Modal ch·ªçn ƒë·ªô kh√≥ -->
  <div class="modal" id="difficultyModal"
    style="position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); z-index:999;">
    <div class="modal-content" style="background:#fff;border-radius:15px;padding:20px 30px;max-width:800px;">
      <h2 style="color: red;"> Ch·ªçn b·∫°n 'AI' ƒë·ªÉ thi ƒë·∫•u</h2>
      <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
        <div class="difficulty-card easy"
          style="border:3px solid green; padding:12px; border-radius:12px; width:200px; text-align:center;">
          <img src="https://thumb.ac-illust.com/ec/ec7de22b20b117c9902b8aade7b999f9_t.jpeg" alt="D·ªÖ"
            style="width:100px;height:100px;">
          <h3 style="color:green;">AI H·ªåC SINH (D·ªÑ)</h3>
          <p>ƒê√£ ƒë∆∞·ª£c hu·∫•n luy·ªán trong 1 ng√†y</p>
          <button onclick="selectDifficulty('easy')">Ch·ªçn</button>
        </div>
        <div class="difficulty-card medium"
          style="border:3px solid blue; padding:12px; border-radius:12px; width:200px; text-align:center;">
          <img src="https://thumb.ac-illust.com/0d/0dfdaa95ec8165782835268165b07539_t.jpeg" alt="Trung B√¨nh"
            style="width:100px;height:100px;">
          <h3 style="color:green;">AI ƒê·∫†I H·ªåC (TH∆Ø·ªúNG)</h3>
          <p>ƒê√£ ƒë∆∞·ª£c hu·∫•n luy·ªán trong 1 tu·∫ßn</p>
          <button onclick="selectDifficulty('medium')">Ch·ªçn</button>
        </div>
        <div class="difficulty-card hard"
          style="border:3px solid red; padding:12px; border-radius:12px; width:200px; text-align:center;">
          <img src="https://i.pinimg.com/564x/0a/d0/c2/0ad0c2dcf22c5257a8bd6385c37aa100.jpg" alt="Kh√≥"
            style="width:100px;height:100px;">
          <h3 style="color:green;">AI L√ÉO L√ÄNG (KH√ì)</h3>
          <p>ƒê√£ ƒë∆∞·ª£c hu·∫•n luy·ªán trong 1 th√°ng</p>
          <button onclick="selectDifficulty('hard')">Ch·ªçn</button>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <header>
      <h1>Ph√¢n lo·∫°i bi m√†u ‚Äî Ng∆∞·ªùi ch∆°i vs AI</h1>
      <div>
        <select id="difficulty">
          <option value="easy">D·ªÖ</option>
          <option value="medium" selected>Trung b√¨nh</option>
          <option value="hard">Kh√≥</option>
        </select>
        <button id="startBtn">B·∫Øt ƒë·∫ßu</button>
        <span class="timer">‚è± <span id="timeLeft">30</span>s</span>
      </div>
    </header>

    <section class="game">
      <div class="boardWrap">
        <div class="side">
          <h2>Ng∆∞·ªùi ch∆°i</h2>
          <div class="board" id="boardHuman">
            <div class="bucket" data-color="red"><span>ƒê·ªè</span>
              <div class="count">0</div>
            </div>
            <div class="bucket" data-color="yellow"><span>V√†ng</span>
              <div class="count">0</div>
            </div>
            <div class="bucket" data-color="blue"><span>Xanh</span>
              <div class="count">0</div>
            </div>
          </div>
          <div class="marbles" id="humanMarbles" aria-live="polite"></div>
          <div class="info">ƒêi·ªÉm: <span id="scoreHuman">0</span> | <span id="statusHuman">...</span></div>
        </div>

        <div class="side">
          <h2>AI</h2>
          <div class="board" id="boardAI">
            <div class="bucket" data-color="red"><span>ƒê·ªè</span>
              <div class="count">0</div>
            </div>
            <div class="bucket" data-color="yellow"><span>V√†ng</span>
              <div class="count">0</div>
            </div>
            <div class="bucket" data-color="blue"><span>Xanh</span>
              <div class="count">0</div>
            </div>
          </div>
          <div class="marbles" id="aiMarbles"></div>
          <div class="info">ƒêi·ªÉm: <span id="scoreAI">0</span> | <span id="statusAI">...</span></div>
        </div>
      </div>
      <div class="footer">K√©o th·∫£ bi v√†o ƒë√∫ng l·ªç. AI c≈©ng ph√¢n lo·∫°i c√πng l√∫c.</div>
    </section>
  </div>

  <div class="overlay" id="overlay">
    <div class="popup">
      <h2>K·∫øt qu·∫£</h2>
      <p id="resultText"></p>
      <button id="btnRestart">Ch∆°i l·∫°i</button>
    </div>
  </div>

  <audio id="soundCorrect" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
  <audio id="soundWrong" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

  <!-- HTML v√† CSS gi·ªØ nguy√™n nh∆∞ code g·ªëc -->
  <script>
    let lastTouchTime = 0;
    let aiStarted = false;
    let currentMarble = null; // L∆∞u tr·ªØ vi√™n bi ƒëang ƒë∆∞·ª£c k√©o
    let touchTimeout = null; // Timeout ƒë·ªÉ debounce touch events
    let touchStartX = 0; // ƒê·ªÉ h·ªó tr·ª£ di chuy·ªÉn m∆∞·ª£t h∆°n tr√™n iOS
    let touchStartY = 0;

    /* ====== Touch Support cho Mobile/Tablet ====== */
    const humanMarblesContainer = document.getElementById('humanMarbles');
    humanMarblesContainer.addEventListener('touchstart', e => {
      e.preventDefault(); // NgƒÉn h√†nh vi m·∫∑c ƒë·ªãnh c·ªßa tr√¨nh duy·ªát
      if (!gameActive) return;

      const target = e.target.closest('.marble');
      if (!target || target.parentElement.id !== 'humanMarbles') return;

      // Ch·ªçn vi√™n bi
      document.querySelectorAll('.marble.selected').forEach(m => m.classList.remove('selected'));
      target.classList.add('selected', 'dragging');
      currentMarble = target;
      statusHuman.textContent = `Ch·ªçn bi ${target.dataset.color}. K√©o ho·∫∑c ch·∫°m v√†o l·ªç ƒë·ªÉ th·∫£.`;
      lastTouchTime = Date.now();

      // L∆∞u v·ªã tr√≠ ban ƒë·∫ßu cho transform
      const rect = target.getBoundingClientRect();
      touchStartX = e.touches[0].clientX - rect.left;
      touchStartY = e.touches[0].clientY - rect.top;
      target.style.position = 'fixed';
      target.style.zIndex = '1000';
      target.style.left = `${rect.left}px`;
      target.style.top = `${rect.top}px`;
      target.style.transform = 'translate(0px, 0px)'; // Reset transform
    }, { passive: false });

    // X·ª≠ l√Ω touchmove ƒë·ªÉ di chuy·ªÉn bi (s·ª≠ d·ª•ng transform cho m∆∞·ª£t m√† h∆°n tr√™n iOS)
    document.addEventListener('touchmove', e => {
      if (!gameActive || !currentMarble) return;
      e.preventDefault(); // NgƒÉn cu·ªôn trang
      const touch = e.touches[0];
      const dx = touch.clientX - touchStartX - currentMarble.getBoundingClientRect().left + (currentMarble.offsetWidth / 2);
      const dy = touch.clientY - touchStartY - currentMarble.getBoundingClientRect().top + (currentMarble.offsetHeight / 2);
      currentMarble.style.transform = `translate(${dx}px, ${dy}px)`;
    }, { passive: false });

    // X·ª≠ l√Ω th·∫£ bi v√†o l·ªç
    document.addEventListener('touchend', e => {
      if (!gameActive || !currentMarble) return;
      e.preventDefault();
      const touch = e.changedTouches[0];
      const targetElement = document.elementFromPoint(touch.clientX, touch.clientY);
      const bucket = targetElement ? targetElement.closest('#boardHuman .bucket') : null;
      if (!bucket) {
        // N·∫øu kh√¥ng th·∫£ v√†o bucket, reset v·ªã tr√≠
        currentMarble.style.position = 'static';
        currentMarble.style.transform = '';
        currentMarble.style.zIndex = '';
        currentMarble.classList.remove('dragging', 'selected');
        currentMarble = null;
        return;
      }

      // X·ª≠ l√Ω drop
      handleDrop(bucket, currentMarble);
      currentMarble.style.position = 'static';
      currentMarble.style.transform = '';
      currentMarble.style.zIndex = '';
      currentMarble.classList.remove('dragging', 'selected');
      currentMarble = null;
    }, { passive: false });

    /* ====== DOM refs ====== */
    const colors = ['red', 'yellow', 'blue'];
    const humanMarbles = document.getElementById('humanMarbles');
    const aiMarbles = document.getElementById('aiMarbles');
    const scoreHumanEl = document.getElementById('scoreHuman');
    const scoreAIEl = document.getElementById('scoreAI');
    const statusHuman = document.getElementById('statusHuman');
    const statusAI = document.getElementById('statusAI');
    const startBtn = document.getElementById('startBtn');
    const difficultyEl = document.getElementById('difficulty');
    const timeLeftEl = document.getElementById('timeLeft');
    const overlay = document.getElementById('overlay');
    const resultText = document.getElementById('resultText');
    const btnRestart = document.getElementById('btnRestart');
    const soundCorrect = document.getElementById('soundCorrect');
    const soundWrong = document.getElementById('soundWrong');

    /* ====== state ====== */
    let MARBLES_TOTAL = 6;
    let AI_SPEED = 700;
    let TIME_LIMIT = 30;
    let scoreHuman = 0, scoreAI = 0;
    let gameActive = false;
    let mainTimer = null, aiTimer = null;
    let remainingTime = TIME_LIMIT;

    /* helper: uid */
    function uid() { return 'm' + Date.now().toString(36) + Math.random().toString(36).slice(2, 8); }

    /* update bucket counts */
    function updateBucketCounts(boardId) {
      const buckets = document.querySelectorAll(`#${boardId} .bucket`);
      buckets.forEach(b => {
        const countEl = b.querySelector('.count');
        const color = b.dataset.color;
        const cnt = b.querySelectorAll(`.marble.${color}`).length;
        countEl.textContent = cnt;
      });
    }

    /* clear existing marbles in buckets */
    function clearBuckets(boardId) {
      document.querySelectorAll(`#${boardId} .bucket`).forEach(b => {
        b.querySelectorAll('.marble').forEach(m => m.remove());
        const countEl = b.querySelector('.count');
        if (countEl) countEl.textContent = 0;
      });
    }

    /* create a marble */
    function createMarble(container, color = null) {
      const c = color || colors[Math.floor(Math.random() * colors.length)];
      const m = document.createElement('div');
      m.className = 'marble ' + c;
      const id = uid();
      m.dataset.color = c;
      m.dataset.id = id;
      m.setAttribute('role', 'button');
      m.setAttribute('aria-label', `Bi ${c}`);

      if (container === humanMarbles) {
        m.draggable = true;
        m.addEventListener('dragstart', e => {
          if (!gameActive) { e.preventDefault(); return; }
          e.dataTransfer.setData('text/plain', id);
          e.dataTransfer.setData('color', c);
          m.classList.add('dragging');
        });
        m.addEventListener('dragend', () => {
          m.classList.remove('dragging');
          m.style.position = 'static';
        });
      } else {
        m.draggable = false;
      }

      container.appendChild(m);
      return m;
    }

    /* animate fly */
    function animateFly(m, target) {
      try {
        const rect = m.getBoundingClientRect();
        const clone = m.cloneNode(true);
        clone.classList.add('flying');
        document.body.appendChild(clone);
        clone.style.left = rect.left + 'px';
        clone.style.top = rect.top + 'px';
        clone.style.width = rect.width + 'px';
        clone.style.height = rect.height + 'px';
        clone.style.transformOrigin = 'center';
        requestAnimationFrame(() => {
          const t = target.getBoundingClientRect();
          const dx = t.left + t.width / 2 - rect.left;
          const dy = t.top + t.height / 2 - rect.top;
          clone.style.transform = `translate(${dx}px, ${dy}px) scale(0.35)`;
          clone.style.opacity = '0';
        });
        setTimeout(() => clone.remove(), 600);
      } catch (e) { /* ignore animation errors */ }
    }

    function handleDrop(bucket, el) {
      const expected = bucket.dataset.color;
      animateFly(el, bucket);

      setTimeout(() => {
        if (expected === el.dataset.color) {
          bucket.appendChild(el);
          el.style.position = 'static';
          el.style.transform = 'scale(0.7)';
          el.style.margin = '2px';

          scoreHuman++;
          scoreHumanEl.textContent = scoreHuman;
          statusHuman.textContent = '‚úÖ ƒê√∫ng!';
          soundCorrect && soundCorrect.play().catch(() => { });
          updateBucketCounts('boardHuman');
          if (scoreHuman >= MARBLES_TOTAL) endGameEarly('player');
        } else {
          statusHuman.textContent = '‚ùå Sai!';
          soundWrong && soundWrong.play().catch(() => { });
          humanMarbles.appendChild(el);
          updateBucketCounts('boardHuman');
        }
        el.classList.remove('selected');
        if (!aiStarted) {
          aiStarted = true;
          runAI();
        }
      }, 220);
    }

    /* DROP handlers for human buckets */
    function setupDropHandlers() {
      document.querySelectorAll('#boardHuman .bucket').forEach((bucket, i) => {
        const newBucket = bucket.cloneNode(true);
        bucket.parentNode.replaceChild(newBucket, bucket);
      });

      document.querySelectorAll('#boardHuman .bucket').forEach(bucket => {
        bucket.addEventListener('dragover', e => {
          if (gameActive) {
            e.preventDefault();
            bucket.classList.add('highlight');
          }
        });
        bucket.addEventListener('dragleave', () => bucket.classList.remove('highlight'));
        bucket.addEventListener('drop', e => {
          if (!gameActive) return;
          e.preventDefault();
          bucket.classList.remove('highlight');

          let id = e.dataTransfer.getData('text/plain');
          let el = document.querySelector(`.marble[data-id="${id}"]`) || document.querySelector('.marble.selected');
          if (!el) return;

          handleDrop(bucket, el);
        });
      });
    }

    /* AI behavior */
    function runAI() {
      clearBuckets('boardAI');
      const marbles = [...aiMarbles.querySelectorAll('.marble')];
      scoreAI = 0;
      scoreAIEl.textContent = scoreAI;
      let idx = 0;
      statusAI.textContent = 'AI ƒëang ph√¢n lo·∫°i...';
      if (aiTimer) {
        clearInterval(aiTimer);
        aiTimer = null;
      }
      aiTimer = setInterval(() => {
        if (!gameActive) {
          clearInterval(aiTimer);
          aiTimer = null;
          return;
        }
        if (idx >= marbles.length) {
          clearInterval(aiTimer);
          aiTimer = null;
          statusAI.textContent = 'AI xong';
          return;
        }
        const m = marbles[idx++];
        const c = m.dataset.color;
        const bucket = document.querySelector(`#boardAI .bucket[data-color="${c}"]`);
        if (bucket) {
          animateFly(m, bucket);
          setTimeout(() => {
            bucket.appendChild(m);
            m.style.position = 'static';
            m.style.transform = 'scale(0.7)';
            m.style.margin = '2px';
            scoreAI++;
            scoreAIEl.textContent = scoreAI;
            updateBucketCounts('boardAI');
            if (scoreAI >= MARBLES_TOTAL) {
              endGameEarly('ai');
            }
          }, 260);
        } else {
          scoreAI++;
          scoreAIEl.textContent = scoreAI;
          if (scoreAI >= MARBLES_TOTAL) {
            endGameEarly('ai');
          }
        }
      }, AI_SPEED);
    }

    /* Timer */
    function startTimer(t = 30) {
      remainingTime = t;
      timeLeftEl.textContent = remainingTime;
      if (mainTimer) clearInterval(mainTimer);
      mainTimer = setInterval(() => {
        remainingTime--;
        timeLeftEl.textContent = remainingTime;
        if (remainingTime <= 0) {
          clearInterval(mainTimer);
          mainTimer = null;
          if (aiTimer) {
            clearInterval(aiTimer);
            aiTimer = null;
          }
          gameActive = false;
          statusHuman.textContent = '‚èπ H·∫øt gi·ªù!';
          statusAI.textContent = '‚èπ H·∫øt gi·ªù!';
          showResult();
        }
      }, 1000);
    }

    /* End early */
    function endGameEarly(winner) {
      if (mainTimer) {
        clearInterval(mainTimer);
        mainTimer = null;
      }
      if (aiTimer) {
        clearInterval(aiTimer);
        aiTimer = null;
      }
      gameActive = false;
      if (winner === 'player') {
        statusHuman.textContent = 'üéâ Ho√†n th√†nh!';
      }
      if (winner === 'ai') {
        statusAI.textContent = 'ü§ñ Ho√†n th√†nh!';
      }
      showResult();
    }

    /* Show result */
    function showResult() {
      overlay.style.display = 'flex';
      let msg = `B·∫°n: ${scoreHuman} ƒëi·ªÉm | AI: ${scoreAI} ƒëi·ªÉm<br/>`;
      if (scoreHuman > scoreAI) msg += "üéâ B·∫°n th·∫Øng!";
      else if (scoreHuman < scoreAI) msg += "ü§ñ AI th·∫Øng!";
      else msg += "‚öñÔ∏è H√≤a!";
      resultText.innerHTML = msg;
    }

    function restart() {
      overlay.style.display = 'none';
      if (mainTimer) {
        clearInterval(mainTimer);
        mainTimer = null;
      }
      if (aiTimer) {
        clearInterval(aiTimer);
        aiTimer = null;
      }
      startGame();
    }
    btnRestart.addEventListener('click', restart);

    /* Start game */
    function startGame() {
      aiStarted = false;
      statusAI.textContent = "ü§ñ ƒêang ch·ªù b·∫°n...";
      if (gameActive) return;
      const diff = difficultyEl.value;
      if (diff === 'easy') {
        MARBLES_TOTAL = 5;
        AI_SPEED = 1200;
        TIME_LIMIT = 30;
      } else if (diff === 'medium') {
        MARBLES_TOTAL = 6;
        AI_SPEED = 700;
        TIME_LIMIT = 30;
      } else if (diff === 'hard') {
        MARBLES_TOTAL = 7;
        AI_SPEED = 400;
        TIME_LIMIT = 30;
      }

      scoreHuman = 0;
      scoreAI = 0;
      scoreHumanEl.textContent = '0';
      scoreAIEl.textContent = '0';
      statusHuman.textContent = 'B·∫Øt ƒë·∫ßu';
      statusAI.textContent = 'Chu·∫©n b·ªã';
      humanMarbles.innerHTML = '';
      aiMarbles.innerHTML = '';
      clearBuckets('boardHuman');
      clearBuckets('boardAI');
      gameActive = true;

      for (let i = 0; i < MARBLES_TOTAL; i++) {
        createMarble(humanMarbles);
        createMarble(aiMarbles);
      }

      updateBucketCounts('boardHuman');
      updateBucketCounts('boardAI');

      setupDropHandlers();
      startTimer(TIME_LIMIT);
    }

    startBtn.addEventListener('click', startGame);

    function selectDifficulty(level) {
      if (level === "easy") difficultyEl.value = "easy";
      else if (level === "medium") difficultyEl.value = "medium";
      else difficultyEl.value = "hard";
      document.getElementById("difficultyModal").style.display = "none";
      startGame(); // G·ªçi tr·ª±c ti·∫øp h√†m startGame thay v√¨ click button ƒë·ªÉ tr√°nh v·∫•n ƒë·ªÅ tr√™n mobile
    }

    /* initialize preview */
    (function initPreview() {
      humanMarbles.innerHTML = '';
      aiMarbles.innerHTML = '';
      for (let i = 0; i < 4; i++) {
        createMarble(humanMarbles);
        createMarble(aiMarbles);
      }
      updateBucketCounts('boardHuman');
      updateBucketCounts('boardAI');
      setupDropHandlers();
    })();

    /* accessibility: ESC clears selection */
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.marble.selected').forEach(x => x.classList.remove('selected'));
        if (currentMarble) {
          currentMarble.style.position = 'static';
          currentMarble.style.transform = '';
          currentMarble.classList.remove('dragging');
          currentMarble = null;
        }
      }
    });

    // overlay click outside popup does nothing
    overlay.addEventListener('click', e => {
      if (e.target === overlay) { /* do nothing */ }
    });
  </script>
</body>

</html>